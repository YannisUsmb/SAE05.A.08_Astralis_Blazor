@page "/admin/dashboard"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject AdminDashboardViewModel ViewModel

<PageTitle>Administration – Astralis</PageTitle>

<div class="content-wrapper">
    <div class="page-header mb-4">
        <h1><i class="bi bi-shield-lock-fill me-2"></i>Administration des Découvertes</h1>
        <p class="text-white-50 text-center">Validez ou refusez les soumissions des utilisateurs.</p>
    </div>

    @if (ViewModel.IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-accent-purple"></div>
            <p class="mt-2 text-white-50">Chargement...</p>
        </div>
    }
    else
    {
        <div class="glass-panel p-4 animate-fade-in">
            @if (!ViewModel.PendingDiscoveries.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <h4 class="mt-3 font-orbitron">Tout est à jour !</h4>
                    <p class="text-white-50">Aucune découverte en attente de validation.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Type</th>
                                <th>Auteur</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var discovery in ViewModel.PendingDiscoveries)
                        {
                            <tr>
                                <td class="fw-bold text-white">@discovery.CelestialBodyName</td>
            
                                <td>
                                    <span class="badge bg-secondary border border-white-10">
                                        @discovery.CelestialBodyTypeName
                                    </span>
                                </td>
            
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-person-circle text-white-50"></i>
                                        @discovery.Username
                                    </div>
                                </td>
                                
            
                                <td class="text-end">
                                    <div class="btn-group">
                                        <a href="/corps-celestes?id=@discovery.CelestialBodyId" class="btn btn-sm btn-info" title="Voir les détails">
                                            <i class="bi bi-eye"></i>
                                        </a>
                    
                                        <button class="btn btn-sm btn-success" @onclick="() => ViewModel.ApproveDiscovery(discovery.Id)" title="Valider">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                    
                                        <button class="btn btn-sm btn-danger" @onclick="() => ViewModel.OpenRejectModal(discovery.Id)" title="Refuser">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>

@if (ViewModel.IsRejectModalOpen)
{
    <div class="modal-backdrop-custom" @onclick="ViewModel.CancelRejection">
        <div class="modal-glass-content animate-fade-in" @onclick:stopPropagation style="max-width: 500px;">
            <div class="modal-header border-0 pb-0">
                <h4 class="text-white font-orbitron text-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Refuser la découverte
                </h4>
            </div>
            <div class="modal-body">
                <p class="text-white-50">
                    Cette action est irréversible. L'auteur recevra une notification avec le motif ci-dessous.
                </p>
                
                <div class="mb-3">
                    <label class="form-label text-white small">Motif du refus <span class="text-danger">*</span></label>
                    <textarea class="form-control-astralis" rows="4" 
                              placeholder="Ex: Données incohérentes, doublon, contenu inapproprié..."
                              @bind="ViewModel.RejectionReason"></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 gap-2">
                <button class="btn btn-outline-light" @onclick="ViewModel.CancelRejection">Annuler</button>
                <button class="btn btn-danger" 
                        @onclick="ViewModel.ConfirmRejection"
                        disabled="@string.IsNullOrWhiteSpace(ViewModel.RejectionReason)">
                    Confirmer le refus
                </button>
            </div>
        </div>
    </div>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync();
    }
}