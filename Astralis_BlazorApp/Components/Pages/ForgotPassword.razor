@page "/mot-de-passe-oublie"
@using Astralis.Shared.DTOs
@using Astralis_BlazorApp.Services.Interfaces
@inject IAuthService AuthService

<div class="d-flex justify-content-center align-items-center min-vh-100">
    <div class="glass-panel p-5" style="max-width: 500px; width: 100%;">

        <h2 class="text-white mb-3 text-center">Mot de passe oublié ?</h2>
        <p class="text-white-50 mb-4 text-center">Entrez votre email pour recevoir un lien de réinitialisation.</p>

        @if (isSent)
        {
            <div class="alert alert-success bg-opacity-25 border-0 text-white">
                <i class="bi bi-check-circle me-2"></i> Si un compte existe avec cet email, vous recevrez un lien d'ici quelques minutes.
            </div>
            <div class="text-center mt-4">
                <NavLink href="/connexion" class="btn btn-astralis-outline">Retour à la connexion</NavLink>
            </div>
        }
        else
        {
            <EditForm Model="forgotDto" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <div class="form-group mb-4">
                    <label class="text-white mb-2">Adresse Email</label>
                    <InputText @bind-Value="forgotDto.Email" class="form-control-astralis" placeholder="ex: thomas@astralis.space" />
                    <ValidationMessage For="@(() => forgotDto.Email)" />
                </div>

                <button type="submit" class="btn btn-astralis-premium w-100" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Envoyer le lien
                </button>
            </EditForm>

            <div class="text-center mt-3">
                <NavLink href="/connexion" class="text-white-50 text-decoration-none small hover-white">Annuler</NavLink>
            </div>
        }
    </div>
</div>

@code {
    private ForgotPasswordDto forgotDto = new();
    private bool isLoading = false;
    private bool isSent = false;

    private async Task HandleSubmit()
    {
        isLoading = true;
        try
        {
            await AuthService.ForgotPasswordAsync(forgotDto.Email);
            isSent = true;
        }
        catch
        {
            isSent = true;
        }
        finally
        {
            isLoading = false;
        }
    }
}