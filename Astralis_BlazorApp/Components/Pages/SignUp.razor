@page "/inscription"
@using Astralis.Shared.DTOs
@using Astralis.Shared.Enums
@inject SignUpViewModel ViewModel

<PageTitle>Inscription – Astralis</PageTitle>

<div class="login-wrapper">
    <div class="login-card dual">

        <div class="login-left">
            <h1>Rejoindre Astralis</h1>
            <p>Créez votre profil d'explorateur et accédez aux données.</p>

            <EditForm EditContext="ViewModel.EditContext" OnSubmit="ViewModel.RegisterAsync">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                {
                    <div class="alert alert-danger mb-3" role="alert">
                        @ViewModel.ErrorMessage
                    </div>
                }

                <div class="row">
                    <div class="col-md-6 form-group">
                        <label class="required-label">Prénom</label>
                        <InputText class="form-control-astralis" placeholder="Thomas" @bind-Value="ViewModel.RegisterData.FirstName" />
                        <ValidationMessage For="@(() => ViewModel.RegisterData.FirstName)" />
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="required-label">Nom</label>
                        <InputText class="form-control-astralis" placeholder="Pesquet" @bind-Value="ViewModel.RegisterData.LastName" />
                        <ValidationMessage For="@(() => ViewModel.RegisterData.LastName)" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="required-label">Nom d'utilisateur</label>
                    <InputText class="form-control-astralis" placeholder="AstroBoy" @bind-Value="ViewModel.RegisterData.Username" />
                    <ValidationMessage For="@(() => ViewModel.RegisterData.Username)" />
                </div>

                <div class="form-group">
                    <label class="required-label">Email</label>
                    <InputText type="email" class="form-control-astralis" placeholder="thomas@iss.space" @bind-Value="ViewModel.RegisterData.Email" />
                    <ValidationMessage For="@(() => ViewModel.RegisterData.Email)" />
                </div>

                <div class="form-group">
                    <label>Téléphone</label>
                    <div class="input-group-astralis">
                        <InputSelect class="form-control-astralis prefix-select" @bind-Value="ViewModel.RegisterData.CountryId">
                            <option value="">Choisir...</option>
                            @foreach (var country in ViewModel.Countries)
                            {
                                <option value="@country.Id">@country.Name (@country.PhonePrefix)</option>
                            }
                        </InputSelect>

                        <InputText class="form-control-astralis phone-input"
                                   placeholder="06 12 34 56 78"
                                   @bind-Value="ViewModel.RegisterData.Phone"
                                   @onfocusout="ViewModel.FormatPhoneNumber" />
                    </div>
                    <ValidationMessage For="@(() => ViewModel.RegisterData.CountryId)" />
                    <ValidationMessage For="@(() => ViewModel.RegisterData.Phone)" />
                </div>

                <div class="form-group">
                    <label class="required-label">Genre</label>
                    <InputSelect class="form-control-astralis" @bind-Value="ViewModel.RegisterData.Gender">
                        @foreach (GenderType gender in Enum.GetValues(typeof(GenderType)))
                        {
                            <option value="@gender">@GetFrenchGenderLabel(gender)</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => ViewModel.RegisterData.Gender)" />
                </div>

                <div class="form-group">
                    <label>Photo de profil</label>

                    <div class="d-flex align-items-center gap-3">
                        @if (!string.IsNullOrEmpty(ViewModel.RegisterData.AvatarUrl))
                        {
                            <img src="@ViewModel.RegisterData.AvatarUrl"
                                 class="rounded-circle border border-secondary"
                                 style="width: 50px; height: 50px; object-fit: cover;"
                                 alt="Avatar" />
                        }
                        else
                        {
                            <div class="rounded-circle bg-dark border border-secondary d-flex align-items-center justify-content-center"
                                 style="width: 50px; height: 50px;">
                                <i class="bi bi-person text-white-50" style="font-size: 1.5rem;"></i>
                            </div>
                        }

                        <div class="flex-grow-1">
                            <InputFile OnChange="OnFileSelected"
                                       class="form-control-astralis"
                                       accept=".jpg,.jpeg,.png" />

                            @if (ViewModel.IsUploading)
                            {
                                <div class="text-accent-purple small mt-1">
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                    Envoi en cours...
                                </div>
                            }
                        </div>
                    </div>

                    <ValidationMessage For="@(() => ViewModel.RegisterData.AvatarUrl)" />
                </div>

                <div class="row">
                    <div class="col-md-6 form-group">
                        <label class="required-label">Mot de passe</label>
                        <InputText type="password" class="form-control-astralis" @bind-Value="ViewModel.RegisterData.Password" />
                        <ValidationMessage For="@(() => ViewModel.RegisterData.Password)" />
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="required-label">Confirmation</label>
                        <InputText type="password" class="form-control-astralis" @bind-Value="ViewModel.RegisterData.ConfirmPassword" />
                        <ValidationMessage For="@(() => ViewModel.RegisterData.ConfirmPassword)" />
                    </div>
                </div>

                <div class="form-check mb-4 mt-2">
                    <InputCheckbox id="mfa" class="form-check-input bg-dark border-secondary" @bind-Value="ViewModel.RegisterData.MultiFactorAuthentification" />
                    <label class="form-check-label text-muted small" for="mfa">
                        Activer l'authentification double facteur (A2F)
                    </label>
                </div>

                <button type="submit" class="btn-login" disabled="@ViewModel.IsLoading">
                    @if (ViewModel.IsLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Création en cours...</span>
                    }
                    else
                    {
                        <span>S'inscrire</span>
                    }
                </button>

                <div class="login-footer">
                    <p>Déjà un compte ? <NavLink href="/connexion">Se connecter</NavLink></p>
                </div>
            </EditForm>
        </div>

        <div class="login-right">
            <h2>Rejoindre via</h2>
            <div class="social-login">
                <button type="button" class="btn-social">
                    <img src="/assets/google.svg" alt="Google" width="24" height="24" />
                    <span>Google</span>
                </button>
                <button type="button" class="btn-social">
                    <img src="/assets/facebook.svg" alt="Facebook" width="24" height="24" />
                    <span>Facebook</span>
                </button>
                <button type="button" class="btn-social">
                    <img src="/assets/microsoft.svg" alt="Microsoft" width="24" height="24" />
                    <span>Microsoft</span>
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private bool _isUploading = false;

    protected override async Task OnInitializedAsync()
    {
        ViewModel.InitializeContext();

        await ViewModel.LoadCountriesAsync();
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        await ViewModel.UploadAvatarAsync(e.File);
    }

    private string GetFrenchGenderLabel(GenderType gender)
    {
        return gender switch
        {
            GenderType.Male => "Homme",
            GenderType.Female => "Femme",
            GenderType.Other => "Autre",
            _ => "Non précisé"
        };
    }
}