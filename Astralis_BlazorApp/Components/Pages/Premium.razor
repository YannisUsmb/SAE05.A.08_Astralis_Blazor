@page "/premium"
@using Astralis_BlazorApp.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@inject PremiumViewModel ViewModel
@inject NavigationManager Navigation

<PageTitle>Abonnement Premium – Astralis</PageTitle>

<div class="premium-page-container">

    @if (ViewModel.IsLoading)
    {
        <div class="loading-state text-white animate-up">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p>Initialisation du terminal...</p>
        </div>
    }
    else
    {
        <AuthorizeView>
            <NotAuthorized>
                <div class="glass-card auth-wall animate-up">
                    <div class="icon-glow"><i class="bi bi-shield-lock-fill"></i></div>
                    <h1>Accès Restreint</h1>
                    <p>Connectez-vous pour accéder aux accréditations.</p>
                    <button class="btn-neon" @onclick="ViewModel.GoToLogin">Connexion au Terminal</button>
                </div>
            </NotAuthorized>

            <Authorized>
                @if (ViewModel.IsUserPremium)
                {
                    <div class="glass-card dashboard animate-up">
                        <div class="status-badge">
                            <i class="bi bi-patch-check-fill"></i> Actif
                        </div>
                        <h2>Membre Astralis Premium</h2>
                        <p class="subtext">Redirection vers vos paramètres...</p>
                        <button class="btn-outline-neon" @onclick='() => Navigation.NavigateTo("/parametres/premium")'>
                            Accéder à mon espace
                        </button>
                    </div>
                }
                else
                {
                    <div class="offer-container animate-up">
                        <div class="offer-header">
                            <h1>Passez à la vitesse supérieure</h1>
                            <p>Choisissez votre engagement.</p>
                        </div>

                        <div class="plan-toggle-container">
                            <span class="@(!ViewModel.IsYearly ? "active" : "")" @onclick="() => ViewModel.IsYearly = false">Mensuel</span>
                            <div class="toggle-switch @(ViewModel.IsYearly ? "checked" : "")" @onclick="ViewModel.TogglePlan">
                                <div class="slider"></div>
                            </div>
                            <span class="@(ViewModel.IsYearly ? "active" : "")" @onclick="() => ViewModel.IsYearly = true">
                                Annuel <span class="badge-save">-20%</span>
                            </span>
                        </div>

                        <div class="glass-card pricing-card">
                            <div class="card-glow"></div>
                            <div class="pricing-header">
                                <h3>Astralis Premium</h3>
                                <div class="price-tag">
                                    <span class="currency">€</span>
                                    <span class="amount">@(ViewModel.IsYearly ? "144.99" : "14.99")</span>
                                    <span class="period">/@(ViewModel.IsYearly ? "an" : "mois")</span>
                                </div>
                                @if (ViewModel.IsYearly)
                                {
                                    <div class="savings-text">Soit 2 mois offerts !</div>
                                }
                            </div>

                            <div class="features-list">
                                <div class="feature-item highlight">
                                    <div class="feature-icon"><i class="bi bi-soundwave"></i></div>
                                    <div class="feature-text">
                                        <strong>Audio SpatialPRO</strong>
                                        <span>Sonification des ondes radio.</span>
                                    </div>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon"><i class="bi bi-file-earmark-lock2-fill"></i></div>
                                    <div class="feature-text">
                                        <strong>Archives Classifiées</strong>
                                        <span>Accès illimité aux articles.</span>
                                    </div>
                                </div>
                            </div>

                            <button class="btn-neon btn-block" @onclick="ViewModel.SubscribeToPremium">
                                Choisir le plan @(ViewModel.IsYearly ? "Annuel" : "Mensuel")
                            </button>
                            <p class="terms">Paiement sécurisé par Stripe.</p>
                        </div>
                    </div>
                }
            </Authorized>
        </AuthorizeView>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync();

        // Redirection automatique si l'utilisateur est déjà premium
        if (ViewModel.IsUserPremium)
        {
            Navigation.NavigateTo("/parametres/premium");
        }
    }
}