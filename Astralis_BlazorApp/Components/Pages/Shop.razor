@page "/boutique"
@using Astralis.Shared.DTOs
@using Astralis_BlazorApp.ViewModels
@using Astralis_BlazorApp.Services
@inject ShopViewModel ViewModel
@inject ICartService CartService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Boutique – Astralis</PageTitle>

<div class="content-wrapper">

    @if (ViewModel.SelectedProductDetails == null)
    {
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <h1>Boutique Astralis</h1>

            <button class="btn btn-primary position-relative" @onclick='() => Navigation.NavigateTo("/panier")'>
                <i class="bi bi-cart3 me-2"></i> Mon Panier
                @if (CartService.Cart.TotalItemsCount > 0)
                {
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        @CartService.Cart.TotalItemsCount
                    </span>
                }
            </button>
        </div>

        <p class="page-description">Équipements, modules et ressources pour vos voyages interstellaires</p>

        <div class="filters-container">
            <input type="text" class="filter-input" placeholder="🔍 Rechercher..."
                   @bind="ViewModel.SearchText"
                   @bind:event="oninput" />

            <select class="filter-input"
                    @bind="ViewModel.SelectedTypeId"
                    @bind:after="@(() => ViewModel.ApplyFilterCommand.ExecuteAsync(null))">
                <option value="0">Toutes les catégories</option>
                @foreach (ProductCategoryDto cat in ViewModel.ProductCategories)
                {
                    <option value="@cat.Id">@cat.Label</option>
                }
            </select>

            <select class="filter-input"
                    @bind="ViewModel.SortBy"
                    @bind:after="@(() => ViewModel.ApplyFilterCommand.ExecuteAsync(null))">
                <option value="name">Nom (A–Z)</option>
                <option value="category">Catégorie (A–Z)</option>
                <option value="price_asc">Prix (Croissant)</option>
                <option value="price_desc">Prix (Décroissant)</option>
            </select>

            <div class="d-flex gap-3 align-items-center">
                <span class="text-white small">Prix :</span>
                <input type="number" class="filter-input filter-input-sm" placeholder="Min"
                       @bind="ViewModel.Filter.MinPrice" />
                <span class="text-white">-</span>
                <input type="number" class="filter-input filter-input-sm" placeholder="Max"
                       @bind="ViewModel.Filter.MaxPrice" />

                <button class="btn btn-astralis-outline btn-sm"
                        @onclick="@(() => ViewModel.ApplyFilterCommand.ExecuteAsync(null))">
                    Appliquer
                </button>
            </div>
        </div>

        <div class="bodies-grid">
            @if (ViewModel.IsLoading)
            {
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            }
            else if (ViewModel.Products.Count == 0)
            {
                <div class="text-center text-white w-100"><p>Aucun produit ne correspond à vos critères.</p></div>
            }
            else
            {
                @foreach (ProductListDto product in ViewModel.Products)
                {
                    <div class="body-card" @onclick="() => OpenDetails(product)">
                        <img src="@product.ProductPictureUrl" alt="@product.Label image" class="body-image" />
                        <div class="body-info">
                            <h3>@product.Label</h3>
                            <h4 class="body-price">@product.Price €</h4>
                            <p><span class="badge-type">@product.CategoryLabel</span></p>

                            <button class="btn btn-primary btn-lg"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ViewModel.AddToCart(product)">
                                <i class="bi bi-cart-plus me-2"></i> Ajouter
                            </button>
                        </div>
                    </div>
                }
            }
        </div>

        @if (!ViewModel.IsLoading && ViewModel.Products.Count > 0)
        {
            <div class="pagination-container">
                <button class="btn btn-astralis-outline"
                        @onclick="@(() => ViewModel.PreviousPageCommand.ExecuteAsync(null))"
                        disabled="@(ViewModel.CurrentPage == 1)">Précédent</button>
                <span class="text-white">Page @ViewModel.CurrentPage</span>
                <button class="btn btn-astralis-outline"
                        @onclick="@(() => ViewModel.NextPageCommand.ExecuteAsync(null))"
                        disabled="@(!ViewModel.HasNextPage)">Suivant</button>
            </div>
        }
    }

    @if (ViewModel.SelectedProductDetails != null)
    {
        <div class="details-view animate-fade-in">
            <button class="btn btn-secondary mb-3" @onclick="@(() => ViewModel.BackToListCommand.Execute(null))">
                ← Retour
            </button>

            @if (ViewModel.IsLoading)
            {
                <div class="spinner-container"><div class="spinner-border text-primary"></div></div>
            }
            else
            {
                <div class="detail-container">
                    <div class="d-flex flex-column align-items-center mb-4">
                            <h2>@ViewModel.SelectedProductDetails.Label</h2>
                            <span class="badge-type">@ViewModel.SelectedProductDetails.CategoryLabel</span>
                        </div>

                    <div class="detail-image-div">
                        <img class="detail-image" src="@ViewModel.SelectedProductDetails.ProductPictureUrl" alt="@ViewModel.SelectedProductDetails.Label image" />
                        <h2 class="detail-price">@ViewModel.SelectedProductDetails.Price.ToString("C")</h2>
                    </div>

                    @if (!string.IsNullOrEmpty(ViewModel.SelectedProductDetails.Description))
                    {
                        <div class="remark-section mt-4">
                            <h4>Description</h4>
                            <p>@ViewModel.SelectedProductDetails.Description</p>
                        </div>
                    }

                    <div class="specific-details mt-4">
                        <h3>Informations Techniques</h3>
                        <div class="details-grid">
                            <div class="detail-item"><span class="label">Catégorie</span><span class="value">@ViewModel.SelectedProductDetails.CategoryLabel</span></div>
                            <div class="detail-item"><span class="label">Prix Unitaire</span><span class="value">@ViewModel.SelectedProductDetails.Price.ToString("N2") €</span></div>
                            <div class="detail-item"><span class="label">Disponibilité</span><span class="value text-success">En Stock</span></div>
                        </div>
                    </div>
                    <div class="mt-5 d-flex justify-content-end">
                        <button class="btn btn-primary btn-lg"
                                @onclick="() => ViewModel.AddToCart(ViewModel.SelectedProduct!)">
                            <i class="bi bi-cart-plus me-2"></i> Ajouter
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        // On s'abonne aux events pour mettre à jour le compteur en temps réel
        ViewModel.PropertyChanged += (sender, e) => StateHasChanged();
        CartService.OnChange += StateHasChanged;

        // On charge les produits et le panier
        await ViewModel.InitializeCommand.ExecuteAsync(null);
        await CartService.LoadCartAsync();
    }

    public void Dispose()
    {
        CartService.OnChange -= StateHasChanged;
    }

    private async Task OpenDetails(ProductListDto product)
    {
        await JSRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);
        ViewModel.ShowDetailsCommand.Execute(product);
    }
}