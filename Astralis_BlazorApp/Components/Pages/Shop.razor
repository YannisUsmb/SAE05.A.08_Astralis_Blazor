@page "/boutique"
@using Astralis.Shared.DTOs
@using Astralis_BlazorApp.ViewModels
@using Astralis_BlazorApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject ShopViewModel ViewModel
@inject ICartService CartService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject HttpClient HttpClient
@implements IDisposable

<PageTitle>Boutique – Astralis</PageTitle>

<div class="content-wrapper">

    @if (ViewModel.SelectedProductDetails == null)
    {
        <div class="page-header position-relative d-flex justify-content-center align-items-center mb-4">
            <h1 class="m-0">Boutique Astralis</h1>
            <button class="btn btn-primary position-absolute end-0" @onclick='() => Navigation.NavigateTo("/panier")'>
                <i class="bi bi-cart3 me-2"></i> Mon Panier
                @if (CartService.Cart.TotalItemsCount > 0)
                {
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        @CartService.Cart.TotalItemsCount
                    </span>
                }
            </button>
        </div>

        <p class="page-description">Équipements, modules et ressources pour vos voyages interstellaires</p>

        <div class="filters-container d-flex flex-wrap align-items-center gap-2">

            <input type="text" class="filter-input" placeholder="🔍 Rechercher..."
                   @bind="ViewModel.SearchText"
                   @bind:event="oninput"
                   style="width: 180px;" />

            <select class="filter-input"
                    @bind="ViewModel.SelectedTypeId"
                    @bind:after="ViewModel.ApplyFilterAsync">
                <option value="0">Toutes catégories</option>
                @foreach (var cat in ViewModel.ProductCategories)
                {
                    <option value="@cat.Id">@cat.Label</option>
                }
            </select>

            <input type="number" class="filter-input" placeholder="Min €"
                   @bind="ViewModel.MinPrice"
                   @bind:after="ViewModel.ApplyFilterAsync"
                   style="width: 90px;" />

            <input type="number" class="filter-input" placeholder="Max €"
                   @bind="ViewModel.MaxPrice"
                   @bind:after="ViewModel.ApplyFilterAsync"
                   style="width: 90px;" />

            <select class="filter-input"
                    @bind="ViewModel.SortBy"
                    @bind:after="ViewModel.ApplyFilterAsync">
                <option value="name">Nom (A–Z)</option>
                <option value="category">Catégorie (A–Z)</option>
                <option value="price_asc">Prix (Croissant)</option>
                <option value="price_desc">Prix (Décroissant)</option>
            </select>

            <div class="d-flex align-items-center gap-3 ms-auto">
                @if (ViewModel.IsCommercialEditor)
                {
                    <button class="btn btn-success d-flex align-items-center gap-2" @onclick="ViewModel.NavigateToCreate">
                        <i class="bi bi-plus-lg"></i> <span class="d-none d-md-inline">Créer</span>
                    </button>
                }
            </div>
        </div>

        <div class="bodies-grid">
            @if (ViewModel.IsLoading)
            {
                <div class="spinner-container"><div class="spinner-border text-primary"></div></div>
            }
            else if (ViewModel.Products.Count == 0)
            {
                <div class="text-center text-white w-100"><p>Aucun produit ne correspond à vos critères.</p></div>
            }
            else
            {
                @foreach (var product in ViewModel.Products)
                {
                    <div class="body-card position-relative" @onclick="() => OpenDetails(product)">

                        @if (ViewModel.IsCommercialEditor)
                        {
                            <a href="/admin/produits/modifier/@product.Id"
                               class="btn btn-warning btn-sm position-absolute top-0 end-0 m-2 shadow-sm"
                               style="z-index: 10; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;"
                               @onclick:stopPropagation="true">
                                <i class="bi bi-pencil-fill text-dark"></i>
                            </a>

                            <button class="btn btn-danger btn-sm position-absolute top-0 start-0 m-2 shadow-sm delete-btn"
                                    style="z-index: 10; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ViewModel.RequestDelete(product)">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        }

                        <img src="@product.ProductPictureUrl" alt="@product.Label image" class="body-image" />
                        <div class="body-info">
                            <h3>@product.Label</h3>
                            <h4 class="body-price">@product.Price.ToString("N2") €</h4>

                            <p><span class="badge-type">@product.CategoryLabel</span></p>

                            <button class="btn btn-primary btn-lg" @onclick:stopPropagation="true" @onclick="() => ViewModel.AddToCart(product)">
                                <i class="bi bi-cart-plus me-2"></i> Ajouter
                            </button>
                        </div>
                    </div>
                }
            }
        </div>

        <div class="d-flex justify-content-center align-items-center gap-3 mt-4 mb-5">
            <button class="btn btn-astralis-outline"
                    disabled="@(ViewModel.CurrentPage <= 1)"
                    @onclick="ViewModel.PreviousPageCommand.ExecuteAsync">
                Précédent
            </button>
            <span class="text-white">Page @ViewModel.CurrentPage</span>
            <button class="btn btn-astralis-outline"
                    disabled="@(!ViewModel.HasNextPage)"
                    @onclick="ViewModel.NextPageCommand.ExecuteAsync">
                Suivant
            </button>
        </div>
    }

    @if (ViewModel.SelectedProductDetails != null)
    {
        <div class="details-view animate-fade-in">
            <button class="btn btn-secondary btn-back-fixed"
                    @onclick="@(() => ViewModel.BackToListCommand.Execute(null))">
                <i class="bi bi-arrow-left me-2"></i> Retour
            </button>

            @if (ViewModel.IsLoading)
            {
                <div class="spinner-container"><div class="spinner-border text-primary"></div></div>
            }
            else
            {
                <div class="detail-container">
                    <div class="d-flex flex-column align-items-center mb-4">
                        <h2>@ViewModel.SelectedProductDetails.Label</h2>

                        <div class="category-tooltip-container">
                            <span class="badge-type">@ViewModel.SelectedProductDetails.CategoryLabel</span>

                            @if (!string.IsNullOrEmpty(ViewModel.SelectedProductDetails.CategoryDescription))
                            {
                                <div class="category-tooltip-text">
                                    @ViewModel.SelectedProductDetails.CategoryDescription
                                </div>
                            }
                        </div>
                    </div>

                    <div class="detail-image-div">
                        <img class="detail-image" src="@ViewModel.SelectedProductDetails.ProductPictureUrl" alt="@ViewModel.SelectedProductDetails.Label" />
                        <h2 class="detail-price">@ViewModel.SelectedProductDetails.Price.ToString("N2") €</h2>
                    </div>

                    @if (!string.IsNullOrEmpty(ViewModel.SelectedProductDetails.Description))
                    {
                        <div class="remark-section mt-4">
                            <h4>Description</h4>
                            <p>@ViewModel.SelectedProductDetails.Description</p>
                        </div>
                    }

                    <div class="mt-5 d-flex justify-content-end gap-3">
                        @if (ViewModel.IsCommercialEditor)
                        {
                            <a href="/admin/produits/modifier/@ViewModel.SelectedProductDetails.Id" class="btn btn-warning btn-lg text-white">
                                <i class="bi bi-pencil-square me-2"></i> Modifier
                            </a>

                            <button class="btn btn-danger btn-sm position-absolute top-0 start-0 m-2 shadow-sm delete-btn"
                                    style="z-index: 10; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ViewModel.RequestDelete(ViewModel.SelectedProduct!)">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        }

                        <button class="btn btn-primary btn-lg" @onclick="AddToCartAndGoBack">
                            <i class="bi bi-cart-plus me-2"></i> Ajouter au panier
                        </button>
                    </div>

                    @if (RelatedProducts != null && RelatedProducts.Any())
                    {
                        <div class="related-products mt-5 pt-4 border-top border-secondary">
                            <h3 class="text-center mb-4" style="color: #a29bfe; font-family: 'Orbitron';">
                                Ces @ViewModel.SelectedProductDetails.CategoryLabel pourraient vous intéresser
                            </h3>

                            <div class="bodies-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
                                @foreach (var related in RelatedProducts)
                                {
                                    <div class="body-card related-card position-relative" @onclick="() => OpenDetails(related)" style="cursor: pointer;">

                                        @if (ViewModel.IsCommercialEditor)
                                        {
                                            <a href="/admin/produits/modifier/@related.Id"
                                               class="btn btn-warning btn-sm position-absolute top-0 end-0 m-1 shadow-sm"
                                               style="z-index: 10; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;"
                                               @onclick:stopPropagation="true">
                                                <i class="bi bi-pencil-fill text-dark" style="font-size: 0.8rem;"></i>
                                            </a>

                                            <button class="btn btn-danger btn-sm position-absolute top-0 start-0 m-1 shadow-sm delete-btn"
                                                    style="z-index: 10; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="() => ViewModel.RequestDelete(related)">
                                                <i class="bi bi-x-lg" style="font-size: 0.8rem;"></i>
                                            </button>
                                        }

                                        <img src="@related.ProductPictureUrl" alt="@related.Label" class="body-image"
                                             style="height: 150px; object-fit: contain; width: 100%;" />

                                        <div class="p-2 text-center">
                                            <strong class="d-block text-truncate">@related.Label</strong>
                                            <span class="text-info">@related.Price.ToString("N0") €</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else if (IsLoadingRelated)
                    {
                        <div class="text-center mt-5 text-muted">
                            <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                            <span class="ms-2">Recherche d'équipements similaires...</span>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@if (ViewModel.ShowDeleteConfirmation && ViewModel.ProductToDelete != null)
{
    <div class="modal-backdrop-custom">
        <div class="modal-content-custom animate-fade-in">
            <div class="modal-header-custom">
                <i class="bi bi-exclamation-triangle-fill text-danger me-2" style="font-size: 1.5rem;"></i>
                <h3>Confirmation</h3>
            </div>

            <div class="modal-body-custom">
                <p>Êtes-vous sûr de vouloir supprimer le produit :</p>
                <p class="product-name-highlight">@ViewModel.ProductToDelete.Label</p>
                <p class="text-muted small">Cette action est irréversible.</p>
            </div>

            <div class="modal-actions-custom">
                <button class="btn btn-secondary" @onclick="ViewModel.CancelDelete">
                    Annuler
                </button>
                <button class="btn btn-danger" @onclick="ViewModel.ConfirmDeleteAsync">
                    <i class="bi bi-trash-fill me-2"></i> Supprimer
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductListDto> RelatedProducts = new();
    private bool IsLoadingRelated = false;

    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += (sender, e) => StateHasChanged();
        CartService.OnChange += StateHasChanged;

        await ViewModel.InitializeCommand.ExecuteAsync(null);
        await CartService.LoadCartAsync();
    }

    public void Dispose()
    {
        CartService.OnChange -= StateHasChanged;
    }

    private async Task OpenDetails(ProductListDto product)
    {
        await JSRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);

        await ViewModel.ShowDetails(product);

        if (product.CategoryId > 0)
        {
            await LoadRelatedProducts(product.CategoryId, product.Id);
        }
    }

    private async Task AddToCartAndGoBack()
    {
        if (ViewModel.SelectedProductDetails != null)
        {
            var productToAdd = new ProductListDto
            {
                Id = ViewModel.SelectedProductDetails.Id,
                Label = ViewModel.SelectedProductDetails.Label,
                Price = ViewModel.SelectedProductDetails.Price,
                ProductPictureUrl = ViewModel.SelectedProductDetails.ProductPictureUrl,
                CategoryId = ViewModel.SelectedProductDetails.CategoryId,
                CategoryLabel = ViewModel.SelectedProductDetails.CategoryLabel
            };

            await ViewModel.AddToCart(productToAdd);

            ViewModel.BackToListCommand.Execute(null);
            await JSRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);
        }
    }

    private async Task LoadRelatedProducts(int categoryId, int currentProductId)
    {
        IsLoadingRelated = true;
        RelatedProducts.Clear();
        StateHasChanged();

        try
        {
            string url = $"Products/Search?ProductCategoryIds={categoryId}&PageSize=15";
            var response = await HttpClient.GetFromJsonAsync<List<ProductListDto>>(url);

            if (response != null)
            {
                RelatedProducts = response
                    .Where(p => p.Id != currentProductId)
                    .OrderBy(x => Guid.NewGuid())
                    .Take(6)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur chargement produits liés : {ex.Message}");
        }
        finally
        {
            IsLoadingRelated = false;
            StateHasChanged();
        }
    }
}