@page "/evenements"
@inject EventViewModel ViewModel
@inject NavigationManager Navigation
@using Astralis.Shared.DTOs

<PageTitle>Événements – Astralis</PageTitle>

<div class="content">
    <section class="header text-center mb-5">
        <h1 class="font-orbitron display-4 mb-3">L'Agenda Cosmique</h1>
        <p class="text-white-50">Conférences, éclipses, lancements... Ne ratez aucun rendez-vous avec l'univers.</p>

        <div class="filters justify-content-center mt-4">
            <input type="text" class="search-input" placeholder="Rechercher..."
                   @bind="ViewModel.SearchText"
                   @bind:event="oninput"
                   @onkeyup="ViewModel.OnFilterChanged" />

            <select class="filter-select" @bind="ViewModel.SortBy" @bind:after="ViewModel.OnFilterChanged">
                <option value="date_asc"> Date (Prochains)</option>
                <option value="type"> Type</option>
                <option value="alpha_asc"> A-Z</option>
            </select>
        </div>
    </section>

    <section class="events-grid-wrapper">
        @if (ViewModel.IsLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-accent-purple" role="status"></div>
            </div>
        }
        else if (ViewModel.Events.Count == 0)
        {
            <div class="text-center py-5 text-white-50">
                <i class="bi bi-telescope fs-1 d-block mb-3"></i>
                Aucun événement ne correspond à votre recherche.
            </div>
        }
        else
        {
            <div class="events-grid">
                @foreach (var evt in ViewModel.Events)
                {
                    <div class="event-card-modern" @onclick="() => NavigateToDetails(evt.Id)">

                        <div class="event-card-image" style="background-image: url('@(evt.PictureUrl ?? "/assets/images/placeholder-space.jpg")');">
                            <div class="event-date-badge">
                                <span class="day">@evt.StartDate.Day</span>
                                <span class="month">@evt.StartDate.ToString("MMM").ToUpper()</span>
                            </div>
                            <div class="event-type-badge">@evt.EventTypeLabel</div>
                        </div>

                        <div class="event-card-body">
                            <h3 class="event-title text-truncate" title="@evt.Title">@evt.Title</h3>

                            <div class="event-meta">
                                <span><i class="bi bi-clock me-1"></i> @evt.StartDate.ToString("HH:mm")</span>
                                <span class="text-truncate"><i class="bi bi-geo-alt me-1"></i> @(evt.Location ?? "En ligne")</span>
                            </div>

                            <div class="event-card-footer mt-3 d-flex justify-content-between align-items-center">
                                <span class="text-accent-purple small fw-bold">Voir les détails <i class="bi bi-arrow-right"></i></span>

                                <button class="btn-icon-interest info-tooltip-wrapper" @onclick:stopPropagation="true">
                                    <i class="bi bi-star"></i>
                                    <span class="custom-tooltip">Ça m'intéresse</span>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </section>

    @if (!ViewModel.IsLoading && ViewModel.Events.Count > 0)
    {
        <div class="pagination-container mt-5">
            <button class="btn btn-astralis-outline" @onclick="ViewModel.PreviousPage" disabled="@(ViewModel.CurrentPage == 1)">Précédent</button>
            <span class="page-info text-white mx-3">Page @ViewModel.CurrentPage</span>
            <button class="btn btn-astralis-outline" @onclick="ViewModel.NextPage" disabled="@(!ViewModel.HasNextPage)">Suivant</button>
        </div>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync();
    }

    private void NavigateToDetails(int id)
    {
        Navigation.NavigateTo($"/evenements/{id}");
    }
}