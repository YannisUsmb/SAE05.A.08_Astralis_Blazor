@page "/articles"
@using Astralis.Shared.DTOs
@using Astralis.Shared.Enums
@using System.Security.Claims
@inject ArticleListViewModel ViewModel
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Actualités Cosmiques – Astralis</PageTitle>

<div class="content-wrapper position-relative">

    @if (_articleToDelete != null)
        {
        <div class="modal-backdrop-custom" @onclick="CancelDelete">
            <div class="modal-glass-content animate-fade-in" @onclick:stopPropagation>
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="text-white font-orbitron">Confirmer la suppression</h4>
                    <p class="text-white-50">
                        Voulez-vous vraiment supprimer l'article : <br />
                        <span class="text-white fw-bold">"@_articleToDelete.Title"</span> ?
                    </p>
                    <p class="small text-danger fst-italic">Cette action est irréversible.</p>
                </div>

                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-outline-light px-4" @onclick="CancelDelete">
                        Annuler
                </button>
                    <button class="btn btn-danger px-4" @onclick="ConfirmDelete">
                        <i class="bi bi-trash-fill me-2"></i> Supprimer
                    </button>
            </div>
            </div>
        </div>
        }

    <div class="page-header">
        <h1>Actualités</h1>
    </div>
    <p class="page-description">Dernières découvertes et rapports d'exploration</p>

    <div class="filters-container">
        <input type="text" class="filter-input" placeholder="🔍 Rechercher..."
               value="@ViewModel.Filter.SearchTerm"
               @oninput="ViewModel.OnSearchInput" />

        <select class="filter-input"
                value="@ViewModel.SelectedTypeId"
                @onchange="OnTypeChanged">
            <option value="0">Toutes les catégories</option>
            @foreach (var type in ViewModel.ArticleTypes)
            {
                <option value="@type.Id">@type.Label</option>
            }
        </select>

        <select class="filter-input"
                value="@ViewModel.Filter.SortBy"
                @onchange="OnSortChanged">
            <option value="date_desc">Plus récents</option>
            <option value="date_asc">Plus anciens</option>
            <option value="title_asc">Nom (A-Z)</option>
        </select>

        <div class="d-flex align-items-center gap-3 ms-auto">
            <div class="form-check form-switch custom-switch m-0">
            <input class="form-check-input" type="checkbox" id="premiumSwitch"
                       checked="@(ViewModel.Filter.IsPremium == true)"
                       @onchange="OnPremiumChanged">
                <label class="form-check-label text-white small fw-bold ms-2" for="premiumSwitch" style="color: #ffd700 !important;">Premium</label>
            </div>

            @if (ViewModel.IsCommercialEditor)
            {
                <button class="btn btn-astralis-premium" @onclick="ViewModel.NavigateToCreate">
                    <i class="bi bi-plus-lg"></i> <span class="d-none d-md-inline">Créer</span>
                </button>
            }
        </div>
    </div>

    <div class="articles-grid">
        @if (ViewModel.IsLoading)
        {
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-accent-purple" role="status"></div>
            </div>
        }
        else if (ViewModel.Articles.Count == 0)
        {
            <div class="col-12 text-center text-white-50 py-5">
                <p class="fs-5">Aucun résultat ne correspond à vos critères.</p>
            </div>
        }
        else
        {
            @foreach (var article in ViewModel.Articles)
            {
                <div class="article-card glass-card h-100 d-flex flex-column">

                    <div class="article-thumb position-relative" @onclick="() => ViewModel.NavigateToDetails(article.Id)" style="cursor: pointer;">
                        <img src="@(string.IsNullOrEmpty(article.CoverImageUrl) ? "/assets/images/placeholder-space.jpg" : article.CoverImageUrl)"
                             class="w-100 h-100 object-fit-cover" alt="Couverture" />

                        @if (article.IsPremium)
                        {
                            <span class="badge-premium"><i class="bi bi-star-fill"></i></span>
                        }

                        @if (ViewModel.IsCommercialEditor)
                        {
                            <div class="article-actions" @onclick:stopPropagation>
                                <a href="/admin/articles/edition/@article.Id" class="btn-action-edit" title="Modifier">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>

                                <button class="btn-action-delete" @onclick="() => OpenDeleteModal(article)" title="Supprimer">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                        }

                        <div class="position-absolute bottom-0 start-0 p-2 d-flex gap-1 flex-wrap">
                            @foreach (var cat in article.CategoryNames.Take(3))
                            {
                                <span class="badge bg-black bg-opacity-75 text-accent-purple border border-white-10">@cat</span>
                            }
                            @if (article.CategoryNames.Count > 3)
                            {
                                <span class="badge bg-black bg-opacity-75 text-white-50 border border-white-10">+@(article.CategoryNames.Count - 3)</span>
                            }
                        </div>
                    </div>

                    <div class="p-4 flex-grow-1 d-flex flex-column" @onclick="() => ViewModel.NavigateToDetails(article.Id)" style="cursor: pointer;">
                        <div class="text-white-50 small mb-2">
                            <i class="bi bi-calendar3 me-1"></i> @article.PublicationDate.ToString("dd MMM yyyy")
                        </div>

                        <h3 class="article-title mb-3">@article.Title</h3>

                        <p class="article-preview flex-grow-1">
                            @article.Preview
                        </p>

                        <div class="d-flex align-items-center justify-content-between mt-3 pt-3 border-top border-white-10">
                            <div class="d-flex align-items-center gap-2">
                                <img src="@article.AuthorAvatarUrl"
                                     class="rounded-circle border border-white-10"
                                     width="32" height="32"
                                     onerror="this.onerror=null;this.src='@GetFallbackAvatar(article.AuthorUsername)';" />
                                <span class="text-white small">@article.AuthorUsername</span>
                            </div>
                            <div class="text-white-50 small">
                                <i class="bi bi-chat-dots me-1"></i> @article.CommentsCount
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    @if (ViewModel.TotalPages > 1)
    {
        <div class="pagination-container">
            <button class="btn btn-astralis-outline" disabled="@(ViewModel.Filter.PageNumber <= 1)"
                    @onclick="() => ChangePage(ViewModel.Filter.PageNumber - 1)">
                Précédent
            </button>
            <span class="text-white mx-3">Page @ViewModel.Filter.PageNumber / @ViewModel.TotalPages</span>
            <button class="btn btn-astralis-outline" disabled="@(ViewModel.Filter.PageNumber >= ViewModel.TotalPages)"
                    @onclick="() => ChangePage(ViewModel.Filter.PageNumber + 1)">
                Suivant
            </button>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery] public string? Search { get; set; }
    [SupplyParameterFromQuery] public int? Type { get; set; }
    [SupplyParameterFromQuery] public bool? Premium { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }
    [SupplyParameterFromQuery] public int? Page { get; set; }

    private ArticleListDto? _articleToDelete;

    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;
        await ViewModel.InitializeAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        ViewModel.Filter.PageNumber = Page ?? 1;
        if (Search != null) ViewModel.Filter.SearchTerm = Search;
        ViewModel.SelectedTypeId = Type ?? 0;
        ViewModel.Filter.IsPremium = Premium;
        ViewModel.Filter.SortBy = Sort ?? "date_desc";

        await ViewModel.SearchDataAsync(updateUrl: false);
    }

    private void OnTypeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val))
        {
            ViewModel.SelectedTypeId = val;
            ViewModel.Filter.PageNumber = 1;
            ViewModel.UpdateUrl();
        }
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        ViewModel.Filter.SortBy = e.Value?.ToString() ?? "date_desc";
        ViewModel.UpdateUrl();
    }

    private void OnPremiumChanged(ChangeEventArgs e)
    {
        ViewModel.Filter.IsPremium = (bool?)e.Value;
        ViewModel.Filter.PageNumber = 1;
        ViewModel.UpdateUrl();
    }

    private void ChangePage(int newPage)
    {
        ViewModel.Filter.PageNumber = newPage;
        ViewModel.UpdateUrl();
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
    }

    private void OpenDeleteModal(ArticleListDto article)
    {
        _articleToDelete = article;
    }

    private void CancelDelete()
    {
        _articleToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (_articleToDelete != null)
        {
            await ViewModel.DeleteArticleAsync(_articleToDelete.Id);
            _articleToDelete = null;
        }
    }

    private string GetFallbackAvatar(string username)
    {
        return $"https://ui-avatars.com/api/?name={username}&background=9d4edd&color=fff&rounded=true";
    }
}