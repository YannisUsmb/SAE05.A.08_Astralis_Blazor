@page "/decouverte/nouvelle"
@using Astralis_BlazorApp.Services.Interfaces
@using Astralis.Shared.DTOs
@using Microsoft.AspNetCore.Authorization
@inject NavigationManager Navigation
@inject IDiscoveryService DiscoveryService
@attribute [Authorize]

<div class="discovery-form-container">
    <div class="form-header">
        <h1>Proposer une nouvelle découverte</h1>
        <p class="text-muted">Partagez votre découverte avec la communauté scientifique</p>
    </div>
    
    <div class="stepper">
        @for (int i = 1; i <= _totalSteps; i++)
        {
            <div class="step @(i == _currentStep ? "active" : "") @(i < _currentStep ? "completed" : "")">
                <div class="step-circle">
                    @if (i < _currentStep)
                    {
                        <i class="bi bi-check-lg"></i>
                    }
                    else
                    {
                        @i
                    }
                </div>
                <span class="step-label">@GetStepLabel(i)</span>
            </div>
        }
    </div>
    
    <div class="form-content">
        @if (_currentStep == 1)
        {
            <StepSelectType @bind-SelectedType="_selectedType" OnNext="NextStep" />
        }
        else if (_currentStep == 2 && _selectedType != null)
        {
            @switch (_selectedType.Value)
            {
                case 1: // Star
                    <StepStarDetails @bind-Model="_starSubmission" OnNext="NextStep" OnPrevious="PreviousStep" />
                    break;
                case 2: // Planet
                    <StepPlanetDetails @bind-Model="_planetSubmission" OnNext="NextStep" OnPrevious="PreviousStep" />
                    break;
                case 3: // Asteroid
                    <StepAsteroidDetails @bind-Model="_asteroidSubmission" OnNext="NextStep" OnPrevious="PreviousStep" />
                    break;
                case 4: // Comet
                    <StepCometDetails @bind-Model="_cometSubmission" OnNext="NextStep" OnPrevious="PreviousStep" />
                    break;
                case 5: // Galaxy/Quasar
                    <StepGalaxyDetails @bind-Model="_galaxySubmission" OnNext="NextStep" OnPrevious="PreviousStep" />
                    break;
                case 6: // Satellite
                    <StepSatelliteDetails @bind-Model="_satelliteSubmission" OnNext="NextStep" OnPrevious="PreviousStep" />
                    break;
            }
        }
        else if (_currentStep == 3)
        {
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    @_errorMessage
                </div>
            }
            <StepReview 
                SelectedType="_selectedType"
                StarSubmission="_starSubmission"
                PlanetSubmission="_planetSubmission"
                AsteroidSubmission="_asteroidSubmission"
                CometSubmission="_cometSubmission"
                GalaxySubmission="_galaxySubmission"
                SatelliteSubmission="_satelliteSubmission"
                OnSubmit="HandleSubmit"
                OnPrevious="PreviousStep" 
                IsSubmitting="_isSubmitting" />
        }
    </div>
</div>

@code {
    private int _currentStep = 1;
    private int _totalSteps = 3;
    private int? _selectedType;
    private bool _isSubmitting;
    private string? _errorMessage = null;
    
    private DiscoveryStarSubmissionDto _starSubmission = new();
    private DiscoveryPlanetSubmissionDto _planetSubmission = new();
    private DiscoveryAsteroidSubmissionDto _asteroidSubmission = new();
    private DiscoveryCometSubmissionDto _cometSubmission = new();
    private DiscoveryGalaxyQuasarSubmissionDto _galaxySubmission = new();
    private DiscoverySatelliteSubmissionDto _satelliteSubmission = new();

    private void NextStep()
    {
        if (_currentStep < _totalSteps)
        {
            _currentStep++;
        }
    }

    private void PreviousStep()
    {
        if (_currentStep > 1)
        {
            _currentStep--;
        }
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
    
        try
        {
            DiscoveryDto? result = _selectedType switch
            {
                1 => await DiscoveryService.CreateStarAsync(_starSubmission),
                2 => await DiscoveryService.CreatePlanetAsync(_planetSubmission),
                3 => await DiscoveryService.CreateAsteroidAsync(_asteroidSubmission),
                4 => await DiscoveryService.CreateCometAsync(_cometSubmission),
                5 => await DiscoveryService.CreateGalaxyAsync(_galaxySubmission),
                6 => await DiscoveryService.CreateSatelliteAsync(_satelliteSubmission),
                _ => null
            };

            if (result != null)
            {
                Navigation.NavigateTo($"/corps-celestes");
            }
            else
            {
                _errorMessage = "Une erreur est survenue lors de la soumission. Veuillez réessayer.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Erreur : {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string GetStepLabel(int step)
    {
        return step switch
        {
            1 => "Type",
            2 => "Détails",
            3 => "Révision",
            _ => ""
        };
    }
}