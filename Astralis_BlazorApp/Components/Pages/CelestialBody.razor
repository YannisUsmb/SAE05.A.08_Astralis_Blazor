@page "/corps-celestes"
@using Astralis.Shared.DTOs
@inject CelestialBodyViewModel ViewModel
@inject NavigationManager Navigation

<PageTitle>Corps C√©lestes ‚Äì Astralis</PageTitle>

<div class="content-wrapper">

    @if (!ViewModel.Is3DVisible)
    {
        <div class="page-header">
            <h1>Corps C√©lestes</h1>
        </div>
        <p class="page-description">Explorez notre base de donn√©es astronomique</p>

        <div class="filters-container">
            <input type="text" class="filter-input" placeholder="üîç Rechercher..."
                   @bind="ViewModel.Filter.SearchText"
                   @bind:event="oninput"
                   @onkeyup="ViewModel.OnFilterChanged" />

            <select class="filter-input" @bind="ViewModel.SelectedTypeId" @bind:after="ViewModel.OnTypeChanged">
                <option value="0">Toutes les cat√©gories</option>
                @foreach (CelestialBodyTypeDto type in ViewModel.CelestialBodyTypes)
                {
                    <option value="@type.Id">@type.Description</option>
                }
            </select>

            <select class="filter-input" @bind="ViewModel.SortBy" @bind:after="ViewModel.OnSortChanged">
                <option value="name_asc">Nom (A‚ÄìZ)</option>
                <option value="name_desc">Nom (Z‚ÄìA)</option>
                <option value="distance">Distance</option>
                <option value="radius">Taille / Rayon</option>
                <option value="mass">Masse (Plan√®tes)</option>
                <option value="temperature">Temp√©rature</option>
            </select>
            
            <AuthorizeView>
                <Authorized>
                    <button class="btn-new-discovery" @onclick="NavigateToDiscoveryForm">
                        <i class="bi bi-plus-circle-fill"></i>
                        <span>Ajouter une nouvelle d√©couverte</span>
                    </button>
                </Authorized>
            </AuthorizeView>
            
            @if (_showSuccessMessage)
            {
                <div class="alert alert-success alert-discovery-success">
                    <i class="bi bi-check-circle-fill"></i>
                    <div>
                        <strong>D√©couverte soumise avec succ√®s !</strong>
                        <p>Votre d√©couverte sera examin√©e par un administrateur avant d'√™tre publi√©e.</p>
                    </div>
                    <button class="btn-close-alert" @onclick="CloseSuccessMessage">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            }
        </div>

        @if (ViewModel.SelectedTypeId != 0)
        {
            <div class="advanced-filters-bar">
                @{
                    bool showSubtypes = ViewModel.SelectedTypeId != 0 && ViewModel.CelestialSubtypes.Count > 0;
                }
                
                @if (showSubtypes)
                {
                    <div class="subtype-filter-wrapper">
                        <select class="filter-pill-select" @bind="ViewModel.SelectedSubtypeId" @bind:after="ViewModel.OnSubtypeChanged">
                            <option value="0">Toutes les sous-cat√©gories</option>
                            @foreach (CelestialBodySubtypeDto sub in ViewModel.CelestialSubtypes)
                            {
                                <option value="@sub.Id">@sub.Label</option>
                            }
                        </select>
                        
                        @if (ViewModel.SelectedSubtypeId != 0)
                        {
                            var selectedSubtype = ViewModel.CelestialSubtypes.FirstOrDefault(s => s.Id == ViewModel.SelectedSubtypeId);
                            if (selectedSubtype != null && !string.IsNullOrEmpty(selectedSubtype.Description))
                            {
                                <InfoTooltip Text="@selectedSubtype.Description" />
                            }
                        }
                    </div>
                }
                
                @if (ViewModel.SelectedTypeId == 1 && ViewModel.Filter.StarFilter != null)
                {
                    <RangeFilter Label="Temp√©rature (K)"
                                 @bind-MinValue="ViewModel.Filter.StarFilter.MinTemperature"
                                 @bind-MaxValue="ViewModel.Filter.StarFilter.MaxTemperature"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Distance (AL)"
                                 @bind-MinValue="ViewModel.Filter.StarFilter.MinDistance"
                                 @bind-MaxValue="ViewModel.Filter.StarFilter.MaxDistance"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Rayon (R‚òâ)"
                                 @bind-MinValue="ViewModel.Filter.StarFilter.MinRadius"
                                 @bind-MaxValue="ViewModel.Filter.StarFilter.MaxRadius"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Luminosit√© (L‚òâ)"
                                 @bind-MinValue="ViewModel.Filter.StarFilter.MinLuminosity"
                                 @bind-MaxValue="ViewModel.Filter.StarFilter.MaxLuminosity"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }
                
                @if (ViewModel.SelectedTypeId == 2 && ViewModel.Filter.PlanetFilter != null)
                {
                    <RangeFilter Label="Masse (M‚äï)"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinMass"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxMass"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Rayon (R‚äï)"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinRadius"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxRadius"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Distance (AL)"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinDistance"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxDistance"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Excentricit√©"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinEccentricity"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxEccentricity"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Magnitude stellaire"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinStellarMagnitude"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxStellarMagnitude"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }
                
                @if (ViewModel.SelectedTypeId == 3 && ViewModel.Filter.AsteroidFilter != null)
                {
                    <RangeFilter Label="Diam√®tre (km)"
                                 @bind-MinValue="ViewModel.Filter.AsteroidFilter.MinDiameter"
                                 @bind-MaxValue="ViewModel.Filter.AsteroidFilter.MaxDiameter"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Magnitude absolue"
                                 @bind-MinValue="ViewModel.Filter.AsteroidFilter.MinAbsoluteMagnitude"
                                 @bind-MaxValue="ViewModel.Filter.AsteroidFilter.MaxAbsoluteMagnitude"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Inclinaison (¬∞)"
                                 @bind-MinValue="ViewModel.Filter.AsteroidFilter.MinInclination"
                                 @bind-MaxValue="ViewModel.Filter.AsteroidFilter.MaxInclination"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Demi-grand axe (UA)"
                                 @bind-MinValue="ViewModel.Filter.AsteroidFilter.MinSemiMajorAxis"
                                 @bind-MaxValue="ViewModel.Filter.AsteroidFilter.MaxSemiMajorAxis"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }
                
                @if (ViewModel.SelectedTypeId == 4 && ViewModel.Filter.CometFilter != null)
                {
                    <RangeFilter Label="Excentricit√©"
                                 @bind-MinValue="ViewModel.Filter.CometFilter.MinEccentricity"
                                 @bind-MaxValue="ViewModel.Filter.CometFilter.MaxEccentricity"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Inclinaison (¬∞)"
                                 @bind-MinValue="ViewModel.Filter.CometFilter.MinInclination"
                                 @bind-MaxValue="ViewModel.Filter.CometFilter.MaxInclination"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="P√©rih√©lie (UA)"
                                 @bind-MinValue="ViewModel.Filter.CometFilter.MinPerihelionAU"
                                 @bind-MaxValue="ViewModel.Filter.CometFilter.MaxPerihelionAU"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Aph√©lie (UA)"
                                 @bind-MinValue="ViewModel.Filter.CometFilter.MinAphelionAU"
                                 @bind-MaxValue="ViewModel.Filter.CometFilter.MaxAphelionAU"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="P√©riode orbitale (ans)"
                                 @bind-MinValue="ViewModel.Filter.CometFilter.MinOrbitalPeriod"
                                 @bind-MaxValue="ViewModel.Filter.CometFilter.MaxOrbitalPeriod"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="MOID (UA)"
                                 @bind-MinValue="ViewModel.Filter.CometFilter.MinMOID"
                                 @bind-MaxValue="ViewModel.Filter.CometFilter.MaxMOID"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }
                
                @if (ViewModel.SelectedTypeId == 5 && ViewModel.Filter.GalaxyFilter != null)
                {
                    <RangeFilter Label="Ascension droite (¬∞)"
                                 @bind-MinValue="ViewModel.Filter.GalaxyFilter.MinRightAscension"
                                 @bind-MaxValue="ViewModel.Filter.GalaxyFilter.MaxRightAscension"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="D√©clinaison (¬∞)"
                                 @bind-MinValue="ViewModel.Filter.GalaxyFilter.MinDeclination"
                                 @bind-MaxValue="ViewModel.Filter.GalaxyFilter.MaxDeclination"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Redshift"
                                 @bind-MinValue="ViewModel.Filter.GalaxyFilter.MinRedshift"
                                 @bind-MaxValue="ViewModel.Filter.GalaxyFilter.MaxRedshift"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Magnitude R"
                                 @bind-MinValue="ViewModel.Filter.GalaxyFilter.MinRMagnitude"
                                 @bind-MaxValue="ViewModel.Filter.GalaxyFilter.MaxRMagnitude"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }
                
                @if (ViewModel.SelectedTypeId == 6 && ViewModel.Filter.SatelliteFilter != null)
                {
                    <RangeFilter Label="Rayon (km)"
                                 @bind-MinValue="ViewModel.Filter.SatelliteFilter.MinRadius"
                                 @bind-MaxValue="ViewModel.Filter.SatelliteFilter.MaxRadius"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Gravit√© (m/s¬≤)"
                                 @bind-MinValue="ViewModel.Filter.SatelliteFilter.MinGravity"
                                 @bind-MaxValue="ViewModel.Filter.SatelliteFilter.MaxGravity"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
        
                    <RangeFilter Label="Densit√© (g/cm¬≥)"
                                 @bind-MinValue="ViewModel.Filter.SatelliteFilter.MinDensity"
                                 @bind-MaxValue="ViewModel.Filter.SatelliteFilter.MaxDensity"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }
            </div>
        }

        <div class="bodies-grid">
            @if (ViewModel.IsLoading)
            {
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            }
            else if (ViewModel.CelestialBodies.Count == 0)
            {
                <div class="text-center text-white w-100">
                    <p>Aucun r√©sultat trouv√©.</p>
                </div>
            }
            else
            {
                @foreach (CelestialBodyListDto body in ViewModel.CelestialBodies)
                {
                    <div class="body-card" @onclick="() => ViewModel.ShowDetails(body)">
                        <div class="body-info">
                            <h3>@body.Name</h3>
                            <p><span class="badge-type">@body.CelestialBodyTypeName</span></p>
                        </div>
                    </div>
                }
            }
        </div>

        @if (!ViewModel.IsLoading && ViewModel.CelestialBodies.Count > 0)
        {
            <div class="pagination-container">
                <button class="btn btn-astralis-outline" @onclick="ViewModel.PreviousPage" disabled="@(ViewModel.CurrentPage == 1)">
                    Pr√©c√©dent
                </button>
                <span class="text-white">Page @ViewModel.CurrentPage</span>
                <button class="btn btn-astralis-outline" @onclick="ViewModel.NextPage" disabled="@(!ViewModel.HasNextPage)">
                    Suivant
                </button>
            </div>
        }
    }

    @if (ViewModel.Is3DVisible)
    {
        <div class="details-view animate-fade-in">
            <button class="btn btn-secondary mb-3" @onclick="ViewModel.BackToList">
                ‚Üê Retour √† la liste
            </button>

            @if (ViewModel.IsLoading)
            {
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-white mt-3">Chargement des d√©tails...</p>
                </div>
            }
            else if (ViewModel.SelectedBodyDetails != null)
            {
                <div class="detail-layout">
                    <div class="detail-info-panel">
                        <div class="detail-header">
                            <h2>@ViewModel.SelectedBodyDetails.Name</h2>
                            @if (!string.IsNullOrEmpty(ViewModel.SelectedBodyDetails.Alias))
                            {
                                <p class="alias">@ViewModel.SelectedBodyDetails.Alias</p>
                            }
                            <span class="badge-type-inline">@ViewModel.SelectedBodyDetails.CelestialBodyTypeName</span>
                        </div>

                        @* STAR DETAILS *@
                        <div class="detail-properties">
                            @if (ViewModel.SelectedBodyDetails.Star != null)
                            {
                                StarDto star = ViewModel.SelectedBodyDetails.Star;
                                
                                @if (!string.IsNullOrEmpty(star.SpectralClassName))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Classe spectrale</span>
                                        <span class="property-value">
                                            @star.SpectralClassName 
                                            @if (!string.IsNullOrEmpty(star.SpectralClassDescription))
                                            {
                                                <InfoTooltip Text="@star.SpectralClassDescription"/>
                                            }
                                        </span>
                                    </div>
                                }
                                @if (star.Temperature.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Temp√©rature</span>
                                        <span class="property-value">@star.Temperature.Value.ToString("N0") K</span>
                                    </div>
                                }
                                @if (star.Distance.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Distance</span>
                                        <span class="property-value">@star.Distance.Value.ToString("N2") AL</span>
                                    </div>
                                }
                                @if (star.Radius.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Rayon</span>
                                        <span class="property-value">@star.Radius.Value.ToString("N2") R‚òâ</span>
                                    </div>
                                }
                                @if (star.Luminosity.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Luminosit√©</span>
                                        <span class="property-value">@star.Luminosity.Value.ToString("N2") L‚òâ</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(star.Constellation))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Constellation</span>
                                        <span class="property-value">@star.Constellation</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(star.Designation))
                                {
                                    <div class="property-row">
                                        <span class="property-label">D√©signation</span>
                                        <span class="property-value">@star.Designation</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(star.BayerDesignation))
                                {
                                    <div class="property-row">
                                        <span class="property-label">D√©signation de Bayer</span>
                                        <span class="property-value">@star.BayerDesignation</span>
                                    </div>
                                }
                                @if (star.ApprovalDate.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Date d'approbation</span>
                                        <span class="property-value">@star.ApprovalDate.Value.ToString("dd/MM/yyyy")</span>
                                    </div>
                                }
                            }

                            @* PLANET DETAILS *@
                            @if (ViewModel.SelectedBodyDetails.Planet != null)
                            {
                                PlanetDto planet = ViewModel.SelectedBodyDetails.Planet;
                                
                                @if (!string.IsNullOrEmpty(planet.PlanetTypeName))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Type de plan√®te</span>
                                        <span class="property-value">
                                            @planet.PlanetTypeName
                                            @if (!string.IsNullOrEmpty(planet.PlanetTypeDescription))
                                            {
                                                <InfoTooltip Text="@planet.PlanetTypeDescription"/>
                                            }
                                        </span>
                                    </div>
                                }
                                @if (planet.Mass.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Masse</span>
                                        <span class="property-value">@planet.Mass.Value.ToString("N2") M‚äï</span>
                                    </div>
                                }
                                @if (planet.Radius.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Rayon</span>
                                        <span class="property-value">@planet.Radius.Value.ToString("N2") R‚äï</span>
                                    </div>
                                }
                                @if (planet.Distance.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Distance</span>
                                        <span class="property-value">@planet.Distance.Value.ToString("N2") AL</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(planet.Temperature))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Temp√©rature</span>
                                        <span class="property-value">@planet.Temperature</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(planet.OrbitalPeriod))
                                {
                                    <div class="property-row">
                                        <span class="property-label">P√©riode orbitale</span>
                                        <span class="property-value">@planet.OrbitalPeriod</span>
                                    </div>
                                }
                                @if (planet.Eccentricity.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Excentricit√©</span>
                                        <span class="property-value">@planet.Eccentricity.Value.ToString("N4")</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(planet.DetectionMethodName))
                                {
                                    <div class="property-row">
                                        <span class="property-label">M√©thode de d√©tection</span>
                                        <span class="property-value">@planet.DetectionMethodName</span>
                                    </div>
                                }
                                @if (planet.DiscoveryYear.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Ann√©e de d√©couverte</span>
                                        <span class="property-value">@planet.DiscoveryYear</span>
                                    </div>
                                }
                                @if (planet.SatelliteCount > 0)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Nombre de satellites</span>
                                        <span class="property-value">@planet.SatelliteCount</span>
                                    </div>
                                }
                                @if (planet.StellarMagnitude.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Magnitude stellaire</span>
                                        <span class="property-value">@planet.StellarMagnitude.Value.ToString("N2")</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(planet.HostStarTemperature))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Temp√©rature √©toile h√¥te</span>
                                        <span class="property-value">@planet.HostStarTemperature</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(planet.HostStarMass))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Masse √©toile h√¥te</span>
                                        <span class="property-value">@planet.HostStarMass</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(planet.Remark))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Remarques</span>
                                        <span class="property-value">@planet.Remark</span>
                                    </div>
                                }
                            }

                            @* ASTEROID DETAILS *@
                            @if (ViewModel.SelectedBodyDetails.Asteroid != null)
                            {
                                AsteroidDto asteroid = ViewModel.SelectedBodyDetails.Asteroid;
                                
                                @if (!string.IsNullOrEmpty(asteroid.OrbitalClassName))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Classe orbitale</span>
                                        <span class="property-value">
                                            @asteroid.OrbitalClassName
                                            @if (!string.IsNullOrEmpty(asteroid.OrbitalClassDescription))
                                            {
                                                <InfoTooltip Text="@asteroid.OrbitalClassDescription"/>
                                            }
                                        </span>
                                    </div>
                                }
                                @if (asteroid.DiameterMaxKm.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Diam√®tre maximal</span>
                                        <span class="property-value">@asteroid.DiameterMaxKm.Value.ToString("N2") km</span>
                                    </div>
                                }
                                @if (asteroid.DiameterMinKm.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Diam√®tre minimal</span>
                                        <span class="property-value">@asteroid.DiameterMinKm.Value.ToString("N2") km</span>
                                    </div>
                                }
                                @if (asteroid.AbsoluteMagnitude.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Magnitude absolue</span>
                                        <span class="property-value">@asteroid.AbsoluteMagnitude.Value.ToString("N2")</span>
                                    </div>
                                }
                                @if (asteroid.IsPotentiallyHazardous.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Statut de danger</span>
                                        <span class="property-value status-@(asteroid.IsPotentiallyHazardous.Value ? "danger" : "safe")">
                                            @(asteroid.IsPotentiallyHazardous.Value ? "Potentiellement dangereux" : "Non dangereux")
                                        </span>
                                    </div>
                                }
                                @if (asteroid.SemiMajorAxis.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Demi-grand axe</span>
                                        <span class="property-value">@asteroid.SemiMajorAxis.Value.ToString("N6") UA</span>
                                    </div>
                                }
                                @if (asteroid.Inclination.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Inclinaison orbitale</span>
                                        <span class="property-value">@asteroid.Inclination.Value.ToString("N2")¬∞</span>
                                    </div>
                                }
                                @if (asteroid.OrbitDeterminationDate.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">D√©termination d'orbite</span>
                                        <span class="property-value">@asteroid.OrbitDeterminationDate.Value.ToString("dd/MM/yyyy")</span>
                                    </div>
                                }
                                @if (asteroid.FirstObservationDate.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Premi√®re observation</span>
                                        <span class="property-value">@asteroid.FirstObservationDate.Value.ToString("dd/MM/yyyy")</span>
                                    </div>
                                }
                                @if (asteroid.LastObservationDate.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Derni√®re observation</span>
                                        <span class="property-value">@asteroid.LastObservationDate.Value.ToString("dd/MM/yyyy")</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(asteroid.Reference))
                                {
                                    <div class="property-row">
                                        <span class="property-label">R√©f√©rence</span>
                                        <span class="property-value">@asteroid.Reference</span>
                                    </div>
                                }
                            }

                            @* SATELLITE DETAILS *@
                            @if (ViewModel.SelectedBodyDetails.Satellite != null)
                            {
                                SatelliteDto satellite = ViewModel.SelectedBodyDetails.Satellite;
                                
                                @if (!string.IsNullOrEmpty(satellite.PlanetName))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Plan√®te h√¥te</span>
                                        <span class="property-value">@satellite.PlanetName</span>
                                    </div>
                                }
                                @if (satellite.Radius.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Rayon</span>
                                        <span class="property-value">@satellite.Radius.Value.ToString("N2") km</span>
                                    </div>
                                }
                                @if (satellite.Gravity.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Gravit√©</span>
                                        <span class="property-value">@satellite.Gravity.Value.ToString("N2") m/s¬≤</span>
                                    </div>
                                }
                                @if (satellite.Density.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Densit√©</span>
                                        <span class="property-value">@satellite.Density.Value.ToString("N2") g/cm¬≥</span>
                                    </div>
                                }
                            }

                            @* GALAXY/QUASAR DETAILS *@
                            @if (ViewModel.SelectedBodyDetails.GalaxyQuasar != null)
                            {
                                GalaxyQuasarDto galaxy = ViewModel.SelectedBodyDetails.GalaxyQuasar;
                                
                                @if (!string.IsNullOrEmpty(galaxy.GalaxyQuasarClassName))
                                {
                                    <div class="property-row">
                                        <span class="property-label">Classe</span>
                                        <span class="property-value">
                                            @galaxy.GalaxyQuasarClassName
                                            @if (!string.IsNullOrEmpty(galaxy.GalaxyClassDescription))
                                            {
                                                <InfoTooltip Text="@galaxy.GalaxyClassDescription"/>
                                            }
                                        </span>
                                    </div>
                                }
                                @if (galaxy.Redshift.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Redshift</span>
                                        <span class="property-value">@galaxy.Redshift.Value.ToString("N4")</span>
                                    </div>
                                }
                                @if (galaxy.RightAscension.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Ascension droite</span>
                                        <span class="property-value">@galaxy.RightAscension.Value.ToString("N6")¬∞</span>
                                    </div>
                                }
                                @if (galaxy.Declination.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">D√©clinaison</span>
                                        <span class="property-value">@galaxy.Declination.Value.ToString("N6")¬∞</span>
                                    </div>
                                }
                                @if (galaxy.RMagnitude.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Magnitude R</span>
                                        <span class="property-value">@galaxy.RMagnitude.Value.ToString("N2")</span>
                                    </div>
                                }
                                @if (galaxy.ModifiedJulianDateObservation.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Date julienne modifi√©e</span>
                                        <span class="property-value">@galaxy.ModifiedJulianDateObservation</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(galaxy.Reference))
                                {
                                    <div class="property-row">
                                        <span class="property-label">R√©f√©rence</span>
                                        <span class="property-value">@galaxy.Reference</span>
                                    </div>
                                }
                            }

                            @* COMET DETAILS *@
                            @if (ViewModel.SelectedBodyDetails.Comet != null)
                            {
                                CometDto comet = ViewModel.SelectedBodyDetails.Comet;
                                
                                @if (comet.OrbitalEccentricity.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Excentricit√© orbitale</span>
                                        <span class="property-value">@comet.OrbitalEccentricity.Value.ToString("N4")</span>
                                    </div>
                                }
                                @if (comet.OrbitalInclinationDegrees.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Inclinaison orbitale</span>
                                        <span class="property-value">@comet.OrbitalInclinationDegrees.Value.ToString("N2")¬∞</span>
                                    </div>
                                }
                                @if (comet.AscendingNodeLongitudeDegrees.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Longitude n≈ìud ascendant</span>
                                        <span class="property-value">@comet.AscendingNodeLongitudeDegrees.Value.ToString("N2")¬∞</span>
                                    </div>
                                }
                                @if (comet.PerihelionDistanceAU.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Distance p√©rih√©lie</span>
                                        <span class="property-value">@comet.PerihelionDistanceAU.Value.ToString("N4") UA</span>
                                    </div>
                                }
                                @if (comet.AphelionDistanceAU.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">Distance aph√©lie</span>
                                        <span class="property-value">@comet.AphelionDistanceAU.Value.ToString("N4") UA</span>
                                    </div>
                                }
                                @if (comet.OrbitalPeriodYears.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">P√©riode orbitale</span>
                                        <span class="property-value">@comet.OrbitalPeriodYears.Value.ToString("N2") ans</span>
                                    </div>
                                }
                                @if (comet.MinimumOrbitIntersectionDistanceAU.HasValue)
                                {
                                    <div class="property-row">
                                        <span class="property-label">MOID</span>
                                        <span class="property-value">@comet.MinimumOrbitIntersectionDistanceAU.Value.ToString("N6") UA</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(comet.Reference))
                                {
                                    <div class="property-row">
                                        <span class="property-label">R√©f√©rence</span>
                                        <span class="property-value">@comet.Reference</span>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <div class="detail-3d-panel">
                        <div class="model-3d-placeholder">
                            <div class="placeholder-content">
                                <i class="bi bi-globe placeholder-icon"></i>
                                <p>Mod√®le 3D √† venir</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center text-white">
                    <p>Erreur lors du chargement des d√©tails</p>
                </div>
            }
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "id")]
    public int? Id { get; set; }
    
    [SupplyParameterFromQuery(Name = "search")]
    public string? SearchText { get; set; }
    
    [SupplyParameterFromQuery(Name = "type")]
    public int? TypeId { get; set; }
    
    [SupplyParameterFromQuery(Name = "subtype")]
    public int? SubtypeId { get; set; }
    
    [SupplyParameterFromQuery(Name = "sort")]
    public string? Sort { get; set; }
    
    [SupplyParameterFromQuery(Name = "page")]
    public int? Page { get; set; }
    
    [SupplyParameterFromQuery(Name = "discoverySubmitted")]
    public bool? DiscoverySubmitted { get; set; }

    [SupplyParameterFromQuery(Name = "id")]
    public int? SubmittedDiscoveryId { get; set; }
    
    private bool _showSuccessMessage = false;

    private void NavigateToDiscoveryForm()
    {
        Navigation.NavigateTo("/decouverte/nouvelle");
    }
    
    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += (s, e) => InvokeAsync(StateHasChanged);
        
        await ViewModel.InitializeAsync();

        if (!string.IsNullOrEmpty(SearchText))
            ViewModel.Filter.SearchText = SearchText;
        
        if (TypeId.HasValue && TypeId.Value != 0)
        {
            ViewModel.SelectedTypeId = TypeId.Value;
            await ViewModel.OnTypeChanged();
        }
        
        if (SubtypeId.HasValue)
            ViewModel.SelectedSubtypeId = SubtypeId.Value;
        
        if (!string.IsNullOrEmpty(Sort))
            ViewModel.SortBy = Sort;
        
        if (Page.HasValue)
            ViewModel.CurrentPage = Page.Value;
        
        if (Id.HasValue)
        {
            await ViewModel.ShowDetailsById(Id.Value);
        }
        else
        {
            await ViewModel.SearchDataAsync();
        }
        
        if (DiscoverySubmitted == true && SubmittedDiscoveryId.HasValue)
        {
            _showSuccessMessage = true;
        }
    }
    
    private void CloseSuccessMessage()
    {
        _showSuccessMessage = false;
    }
}