@page "/corps-celestes"
@inject CelestialBodyViewModel ViewModel

<PageTitle>Corps C√©lestes ‚Äì Astralis</PageTitle>

<div class="content-wrapper">

    @if (!ViewModel.Is3DVisible)
    {
        <div class="page-header">
            <h1>Corps C√©lestes</h1>
        </div>
        <p class="page-description">Explorez notre base de donn√©es astronomique</p>

        <div class="filters-container">
            <input type="text" class="filter-input" placeholder="üîç Rechercher..."
                   @bind="ViewModel.Filter.SearchText"
                   @bind:event="oninput"
                   @onkeyup="ViewModel.OnFilterChanged" />

            <select class="filter-input" @bind="ViewModel.SelectedTypeId" @bind:after="ViewModel.OnTypeChanged">
                <option value="0">Toutes les cat√©gories</option>
                @foreach (var type in ViewModel.CelestialBodyTypes)
                {
                    <option value="@type.Id">@type.Label</option>
                }
            </select>

            <select class="filter-input" @bind="ViewModel.SortBy" @bind:after="ViewModel.OnSortChanged">
                <option value="name">Nom (A‚ÄìZ)</option>
                <option value="distance">Distance</option>
                <option value="radius">Taille / Rayon</option>
                <option value="mass">Masse (Plan√®tes)</option>
                <option value="temperature">Temp√©rature</option>
            </select>
        </div>

        @if (ViewModel.SelectedTypeId != 0)
        {
            <div class="advanced-filters-bar d-flex justify-content-center flex-wrap gap-3 mb-4 animate-fade-in"
                 style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">

                @{
                    var showSubtypes = ViewModel.SelectedTypeId != 0 && ViewModel.CelestialSubtypes.Count > 0;
                }
                <select class="filter-input expandable-filter @(showSubtypes ? "visible" : "")"
                        @bind="ViewModel.SelectedSubtypeId" @bind:after="ViewModel.OnSubtypeChanged">
                    <option value="0">Toutes les sous-cat√©gories</option>
                    @foreach (var sub in ViewModel.CelestialSubtypes)
                    {
                        <option value="@sub.Id">@sub.Label</option>
                    }
                </select>

                @if (ViewModel.SelectedTypeId == 2 && ViewModel.Filter.PlanetFilter != null)
                {
                    <RangeFilter Label="Masse (M‚äï)"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinMass"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxMass"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />

                    <RangeFilter Label="Distance (AL)"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinDistance"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxDistance"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />

                    <RangeFilter Label="Rayon (km)"
                                 @bind-MinValue="ViewModel.Filter.PlanetFilter.MinRadius"
                                 @bind-MaxValue="ViewModel.Filter.PlanetFilter.MaxRadius"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }

                @if (ViewModel.SelectedTypeId == 1 && ViewModel.Filter.StarFilter != null)
                {
                    <RangeFilter Label="Temp√©rature (K)"
                                 @bind-MinValue="ViewModel.Filter.StarFilter.MinTemperature"
                                 @bind-MaxValue="ViewModel.Filter.StarFilter.MaxTemperature"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />

                    <RangeFilter Label="Distance (AL)"
                                 @bind-MinValue="ViewModel.Filter.StarFilter.MinDistance"
                                 @bind-MaxValue="ViewModel.Filter.StarFilter.MaxDistance"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }

                @if (ViewModel.SelectedTypeId == 3 && ViewModel.Filter.AsteroidFilter != null)
                {
                    <RangeFilter Label="Diam√®tre (km)"
                                 @bind-MinValue="ViewModel.Filter.AsteroidFilter.MinDiameter"
                                 @bind-MaxValue="ViewModel.Filter.AsteroidFilter.MaxDiameter"
                                 OnSearchTriggered="ViewModel.OnFilterChanged" />
                }

            </div>
        }

        <div class="bodies-grid">
            @if (ViewModel.IsLoading)
            {
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            }
            else if (ViewModel.CelestialBodies.Count == 0)
            {
                <div class="text-center text-white w-100"><p>Aucun r√©sultat trouv√©.</p></div>
            }
            else
            {
                @foreach (var body in ViewModel.CelestialBodies)
                {
                    <div class="body-card" @onclick="() => ViewModel.ShowDetails(body)">
                        <div class="body-info">
                            <h3>@body.Name</h3>
                            <p><span class="badge-type">@body.CelestialBodyTypeName</span></p>
                        </div>
                    </div>
                }
            }
        </div>

        @if (!ViewModel.IsLoading && ViewModel.CelestialBodies.Count > 0)
        {
            <div class="pagination-container">
                <button class="btn btn-astralis-outline" @onclick="ViewModel.PreviousPage" disabled="@(ViewModel.CurrentPage == 1)">Pr√©c√©dent</button>
                <span class="text-white">Page @ViewModel.CurrentPage</span>
                <button class="btn btn-astralis-outline" @onclick="ViewModel.NextPage" disabled="@(!ViewModel.HasNextPage)">Suivant</button>
            </div>
        }
    }

    @if (ViewModel.Is3DVisible && ViewModel.SelectedBody != null)
    {
        <div class="details-view animate-fade-in">
            <button class="btn btn-secondary mb-3" @onclick="ViewModel.BackToList">
                ‚Üê Retour √† la liste
            </button>

            <h2>@ViewModel.SelectedBody.Name</h2>

            <p>Description : @ViewModel.CelestialBodies</p>
        </div>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync();
    }
}