﻿@page "/connexion"
@using Astralis.Shared.DTOs
@using Astralis.Shared.Enums
@inject LoginViewModel ViewModel
@inject IJSRuntime JS

<PageTitle>Connexion – Astralis</PageTitle>

<div class="login-wrapper">
    <div class="login-card dual">

        <div class="login-left">
            <h1>Connexion</h1>
            <p>Accédez à votre espace Astralis pour explorer les données du cosmos.</p>

            <EditForm EditContext="ViewModel.EditContext" OnSubmit="ViewModel.LoginAsync">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        @ViewModel.ErrorMessage
                    </div>
                }

                <div class="login-mode-switch @(ViewModel.SelectedLoginMode == LoginMode.Phone ? "phone-active" : "")">
                    <div class="mode-slider-bg"></div>
                    <button type="button"
                            class="btn-mode @(ViewModel.SelectedLoginMode == LoginMode.Standard ? "active" : "")"
                            @onclick="() => ViewModel.ToggleLoginMode(LoginMode.Standard)">
                        Identifiant / Email
                    </button>
                    <button type="button"
                            class="btn-mode @(ViewModel.SelectedLoginMode == LoginMode.Phone ? "active" : "")"
                            @onclick="() => ViewModel.ToggleLoginMode(LoginMode.Phone)">
                        Téléphone
                    </button>
                </div>

                <div class="input-slider-viewport @(ViewModel.SelectedLoginMode == LoginMode.Standard ? "mode-standard" : "mode-phone")">

                    <div class="input-slide slide-standard">
                        <div class="form-group">
                            <label>Identifiant ou Email</label>
                            <InputText class="form-control-astralis"
                                       placeholder="AstroBoy ou thomas@iss.space"
                                       @bind-Value="ViewModel.LoginData.Identifier" />

                            @if (ViewModel.SelectedLoginMode == LoginMode.Standard)
                            {
                                <ValidationMessage For="@(() => ViewModel.LoginData.Identifier)" />
                            }
                        </div>
                    </div>

                    <div class="input-slide slide-phone">
                        <div class="form-group">
                            <label>Numéro de téléphone</label>
                            <div class="input-group-astralis">
                                <InputSelect TValue="int?" class="form-control-astralis prefix-select"
                                             Value="@ViewModel.LoginData.CountryId"
                                             ValueChanged="@( (int? c) => ViewModel.OnCountryChanged(c) )"
                                             ValueExpression="@( () => ViewModel.LoginData.CountryId )">

                                    @if (ViewModel.Countries == null || !ViewModel.Countries.Any())
                                    {
                                        <option value="" disabled selected>Chargement...</option>
                                    }
                                    else
                                    {
                                        <option value="">Choisir...</option>
                                        @foreach (var country in ViewModel.Countries)
                                        {
                                            <option value="@country.Id">@country.Name (@country.PhonePrefix)</option>
                                        }
                                    }
                                </InputSelect>

                                <input type="tel" class="form-control-astralis phone-input"
                                       placeholder="@ViewModel.PhonePlaceholder"
                                       value="@ViewModel.LoginData.Phone"
                                       @oninput="@((ChangeEventArgs e) => ViewModel.OnPhoneInput(e.Value?.ToString() ?? ""))"
                                       disabled="@(!ViewModel.LoginData.CountryId.HasValue)" />
                            </div>

                            @if (ViewModel.SelectedLoginMode == LoginMode.Phone)
                            {
                                <ValidationMessage For="@(() => ViewModel.LoginData.CountryId)" />
                                <ValidationMessage For="@(() => ViewModel.LoginData.Phone)" />
                            }
                        </div>
                    </div>

                </div>

                <div class="form-group mt-3">
                    <label>Mot de passe</label>
                    <InputText type="password" class="form-control-astralis" @bind-Value="ViewModel.LoginData.Password" />
                    <ValidationMessage For="@(() => ViewModel.LoginData.Password)" />
                </div>

                <div class="form-actions">
                    <NavLink href="/mot-de-passe-oublie" class="forgot-password">Mot de passe oublié ?</NavLink>
                </div>

                <button type="submit" class="btn-login" disabled="@ViewModel.IsLoading">
                    @if (ViewModel.IsLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Connexion...</span>
                    }
                    else
                    {
                        <span>Se connecter</span>
                    }
                </button>

                <div class="login-footer">
                    <p>Pas encore de compte ? <NavLink href="/inscription">S'inscrire</NavLink></p>
                </div>
            </EditForm>
        </div>

        <div class="login-right">
            <h2>Ou continuer avec</h2>

            <div class="social-login">

                <div class="google-custom-wrapper">
                    <button type="button" class="btn-social">
                        <img src="/assets/google.svg" alt="Google" width="24" height="24" />
                        <span>Continuer avec Google</span>
                    </button>

                    <div id="google-btn-container" class="google-overlay"></div>
                </div>

                <button type="button" class="btn-social">
                    <img src="/assets/facebook.svg" alt="Facebook" width="24" height="24" />
                    <span>Continuer avec Facebook</span>
                </button>

                <button type="button" class="btn-social">
                    <img src="/assets/microsoft.svg" alt="Microsoft" width="24" height="24" />
                    <span>Continuer avec Microsoft</span>
                </button>

            </div>

        </div>

    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.InitializeContext();
        await ViewModel.LoadCountriesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var dotNetReference = DotNetObjectReference.Create(this);

                string clientId = "472091593732-pggcg9c8ohdnaqard33pi7rf10249b5d.apps.googleusercontent.com";

                await JS.InvokeVoidAsync("googleAuth.initialize", dotNetReference, clientId);
                await JS.InvokeVoidAsync("googleAuth.renderButton", "google-btn-container");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Erreur init Google: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task HandleGoogleLogin(string idToken)
    {
        await ViewModel.LoginWithGoogleAsync(idToken);
        StateHasChanged();
    }
}