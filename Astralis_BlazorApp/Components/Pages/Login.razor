@page "/connexion"
@using Astralis.Shared.DTOs
@using Astralis.Shared.Enums
@inject LoginViewModel ViewModel
@inject IJSRuntime JS

<PageTitle>Connexion – Astralis</PageTitle>

<div class="login-wrapper">
    <div class="login-card dual">

        <div class="login-left">
            <h1>Connexion</h1>
            <p>Accédez à votre espace Astralis pour explorer les données du cosmos.</p>

            <EditForm Model="ViewModel.LoginData" OnValidSubmit="ViewModel.LoginAsync">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        @ViewModel.ErrorMessage
                    </div>
                }

                <div class="login-mode-switch">
                    <button type="button"
                            class="btn-mode @(ViewModel.SelectedLoginMode == LoginMode.Standard ? "active" : "")"
                            @onclick="() => ViewModel.SelectedLoginMode = LoginMode.Standard">
                        Identifiant / Email
                    </button>
                    <button type="button"
                            class="btn-mode @(ViewModel.SelectedLoginMode == LoginMode.Phone ? "active" : "")"
                            @onclick="() => ViewModel.SelectedLoginMode = LoginMode.Phone">
                        Téléphone
                    </button>
                </div>

                @if (ViewModel.SelectedLoginMode == LoginMode.Standard)
                {
                    <div class="form-group">
                        <label for="login">Identifiant ou Email</label>
                        <InputText id="login" class="form-control-astralis" @bind-Value="ViewModel.LoginData.Identifier" />
                    </div>
                }
                else
                {
                    <div class="form-group">
                        <label>Téléphone</label>
                        <div class="input-group-astralis">
                            <InputSelect class="form-control-astralis prefix-select" @bind-Value="ViewModel.LoginData.CountryId">
                                <option value="">Choisir...</option>
                                @foreach (var country in ViewModel.Countries)
                                {
                                    <option value="@country.Id">@country.Name (@country.PhonePrefix)</option>
                                }
                            </InputSelect>

                            <InputText class="form-control-astralis phone-input"
                                       placeholder="06 12 34..."
                                       @bind-Value="ViewModel.LoginData.Phone"
                                       @onfocusout="ViewModel.FormatPhoneNumber" />
                        </div>
                    </div>
                }

                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <InputText type="password"
                               id="password"
                               class="form-control-astralis"
                               placeholder="Votre mot de passe"
                               @bind-Value="ViewModel.LoginData.Password" />
                    <ValidationMessage For="@(() => ViewModel.LoginData.Password)" />
                </div>

                <button type="submit" class="btn-login" disabled="@ViewModel.IsLoading">
                    @if (ViewModel.IsLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Connexion en cours...</span>
                    }
                    else
                    {
                        <span>Se connecter</span>
                    }
                </button>

                <div class="login-footer">
                    <p>Pas encore de compte ? <NavLink href="@AppRoutes.SignUp">S'inscrire</NavLink></p>
                    <p><a href="#">Mot de passe oublié ?</a></p>
                </div>
            </EditForm>
        </div>

        <div class="login-right">
            <h2>Autres connexions</h2>
            <div class="social-login">

                <div id="google-btn-container" style="min-height: 40px;"></div>

                <button type="button" class="btn-social">
                    <img src="/assets/facebook.svg" alt="Facebook" width="24" height="24" />
                    <span>Continuer avec Facebook</span>
                </button>

                <button type="button" class="btn-social">
                    <img src="/assets/microsoft.svg" alt="Microsoft" width="24" height="24" />
                    <span>Continuer avec Microsoft</span>
                </button>
            </div>
        </div>

    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ViewModel.LoadCountriesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var dotNetReference = DotNetObjectReference.Create(this);
                string clientId = "472091593732-pggcg9c8ohdnaqard33pi7rf10249b5d.apps.googleusercontent.com";

                await JS.InvokeVoidAsync("googleAuth.initialize", dotNetReference, clientId);
                await JS.InvokeVoidAsync("googleAuth.renderButton", "google-btn-container");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Erreur init Google: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task HandleGoogleLogin(string googleToken)
    {
        await ViewModel.LoginWithGoogleAsync(googleToken);
        StateHasChanged();
    }
}